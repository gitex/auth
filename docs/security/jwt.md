# JWT (Security)

## Термины

- **access token** - короткоживущий токен, используется для авторизации
- **refresh token** - долгоживущий токен, используется для обновления **access token**
- **ротация** - изменение **refresh token**
- **семейство токенов** - **refresh token** связанные друг с другом посредством общего ключа.
Используется для отзыва всех **refresh token** связанных с семейством.

## Статегии

- **Access token**: короткий TTL (5-15 минут), только для бизнес-API
- **Refresh token**: длинный TTL (7-30 дней), используется только для обновления *access*
- **Ротация**: каждый обмен выдаёт **новый refresh**, старый - **инвалидируется**
- **Семейства**: при компрометации - рубим всё семейство токенов.

## Хранение

Браузер:
- Refresh: **HttpOnly + Secure + SameSite=Strict/Lax** cookie.
- Access: **в памяти** (не `localstorage`)
- Всегда **HTTPS + HSTS**

Сервер:
- Не логировать токен
- Выключить автологирование к `/refresh`, либо маскировать значение

## Валидация access token

- Проверяем **подпись** (HS256/RS256)
- Проверяем `exp`/`nbf` с leeway (отклонение, 30-60 секунд)
- Сверить `iss`, `aud`, `kid`
- Проверить **revocation** по `jti`/`family` в хранилище

## Защита `/refresh`

- **CSRF-защита** (cookie + `X-CSRF-Token`)
- **Rate limit**
- **Ротация**: при каждом обмене выдавать **новый refresh token**
- **Reuse detection**: если старый "использованный" refresh token
пришёл снова - **считаем компрометацией, инвалидируем всю семью**.

